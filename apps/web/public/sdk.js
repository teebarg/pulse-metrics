!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(e="undefined"!=typeof globalThis?globalThis:e||self).PulseMetrics=i()}(this,function(){"use strict";const e=new class{constructor(){this.queue=[],this.isInitialized=!1,this.isFlushing=!1,this.retryQueue=[],this.config={apiKey:"",apiUrl:"https://api.pulsemetrics.io",autoTrack:!0,debug:!1,flushInterval:5e3,maxBatchSize:100,maxQueueSize:1e3,retryAttempts:3},this.sessionId=this.generateSessionId()}init(e){this.isInitialized?this.log("SDK already initialized"):e.apiKey?(this.config={...this.config,...e},this.isInitialized=!0,this.log("Initialized with config:",this.config),this.startBatchFlushing(),"undefined"!=typeof window&&(window.addEventListener("beforeunload",()=>this.flush()),window.addEventListener("visibilitychange",()=>{document.hidden&&this.flush()})),this.config.autoTrack&&this.trackPageView()):this.error("API key is required")}track(e,i){if(!this.isInitialized)return void this.error("SDK not initialized. Call init() first.");const t={event_type:e,session_id:this.sessionId,user_id:this.userId,properties:{...i,url:"undefined"!=typeof window?window.location.href:void 0,referrer:"undefined"!=typeof document?document.referrer:void 0,user_agent:"undefined"!=typeof navigator?navigator.userAgent:void 0},timestamp:(new Date).toISOString()};this.log("Tracking event:",t),this.addToQueue(t),["purchase","signup","error"].includes(e)&&this.flush()}trackPageView(e){"undefined"!=typeof window&&this.track("page_view",{page:window.location.pathname,title:document.title,...e})}identify(e){this.userId=e,this.log("User identified:",e),this.track("identify",{user_id:e})}reset(){this.userId=void 0,this.sessionId=this.generateSessionId(),this.log("Session reset")}async flush(){if(0===this.queue.length&&0===this.retryQueue.length)return;if(this.isFlushing)return void this.log("Already flushing, skipping...");this.isFlushing=!0;const e=[...this.retryQueue,...this.queue];this.queue=[],this.retryQueue=[];try{await this.sendEvents(e),this.log(`Successfully sent ${e.length} events`)}catch(i){this.error("Failed to send events:",i),this.retryQueue=[...this.retryQueue,...e.slice(0,this.config.maxQueueSize)]}finally{this.isFlushing=!1}}getQueueSize(){return this.queue.length+this.retryQueue.length}isReady(){return this.isInitialized}addToQueue(e){this.queue.length>=this.config.maxQueueSize&&(this.error("Queue size limit reached, dropping oldest event"),this.queue.shift()),this.queue.push(e),this.queue.length>=this.config.maxBatchSize&&(this.log("Batch size reached, flushing..."),this.flush())}startBatchFlushing(){"undefined"!=typeof window&&(this.flushTimer=window.setInterval(()=>{this.queue.length>0&&this.flush()},this.config.flushInterval))}async sendEvents(e){if(0===e.length)return;const i=`${this.config.apiUrl}/events/batch`,t={events:e};try{const e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify(t),keepalive:!0});if(!e.ok){const i=await e.json().catch(()=>({}));throw new Error(i.message||`HTTP ${e.status}`)}return await e.json()}catch(e){throw this.error("Network error:",e),e}}generateSessionId(){if("undefined"!=typeof window&&window.sessionStorage){const e=sessionStorage.getItem("pulse_session_id");if(e)return e;const i=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("pulse_session_id",i),i}return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}log(...e){this.config.debug}error(...e){}};return"undefined"!=typeof window&&(window.PulseMetrics=e),e});
//# sourceMappingURL=sdk.js.map
