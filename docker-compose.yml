services:
  traefik:
    image: traefik:v2.9
    command:
      - --providers.docker
      - --providers.docker.constraints=Label(`traefik.constraint-label`, `pm-public`)
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443
      # - --log.level=DEBUG  # Debug logging
    ports:
      - 7060:80 # HTTP entrypoint
      - 7061:8080 # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - pm-public
      - default
    labels:
      - traefik.enable=true
      - traefik.constraint-label=pm-public
      # Dashboard route setup
      - traefik.http.routers.traefik-dashboard.entrypoints=http
      - traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)
      - traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080
      - traefik.http.routers.traefik-dashboard.service=api@internal
      - traefik.http.middlewares.https-redirect.contenttype.autodetect=false
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: pulse-metrics
    ports:
      - "7062:5173"  # Vite frontend
      - "7063:8787"  # Hono API
    depends_on:
      - db
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    labels:
      - traefik.enable=true
      - traefik.docker.network=pm-public
      - traefik.constraint-label=pm-public
      # Frontend Router
      - traefik.http.services.app-frontend.loadbalancer.server.port=5173
      - traefik.http.routers.app-frontend-http.rule=Host(`pm.localhost`)
      - traefik.http.routers.app-frontend-http.entrypoints=http
      - traefik.http.routers.app-frontend-http.service=app-frontend
      # API Router (Hono on port 8787)
      - traefik.http.services.app-api.loadbalancer.server.port=8787
      - traefik.http.routers.app-api-http.rule=Host(`api.localhost`)
      - traefik.http.routers.app-api-http.entrypoints=http
      - traefik.http.routers.app-api-http.service=app-api
    command: ["npm", "run", "dev"]
    networks:
      - pm-public
      - default
  db:
    image: pgvector/pgvector:pg18
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U admin -d pm" ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    ports:
      - "7064:5432"
    networks:
      - pm-public
      - default
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: pm
    volumes:
      - pgv-data:/var/lib/postgresql/data

  adminer:
    image: adminer:5.3.0
    ports:
      - "7065:8080"
    networks:
      - pm-public
      - default
    depends_on:
      - db
    labels:
      - traefik.enable=true
      - traefik.docker.network=pm-public
      - traefik.constraint-label=pm-public

      - traefik.http.services.adminer.loadbalancer.server.port=8080

      - traefik.http.routers.adminer-http.rule=Host(`adminer.localhost`)
      - traefik.http.routers.adminer-http.entrypoints=http

volumes:
  pgv-data:

networks:
  pm-public:
    external: false
